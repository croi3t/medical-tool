<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>術前休薬確認ツール Ver15.0 (Offline/Menu)</title>
    <style>
        /* --- [重要] オフライン用CSS (Bootstrap非依存) --- */
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; color: #333; margin: 0; padding: 20px; }
        * { box-sizing: border-box; }
        
        /* ユーティリティクラス再現 */
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .w-100 { width: 100%; }
        .w-50 { width: 50%; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .fw-bold { font-weight: bold; }
        .small { font-size: 0.875rem; }
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .text-muted { color: #6c757d; }
        .text-primary { color: #0d6efd; }
        .text-danger { color: #dc3545; }
        .pt-2 { padding-top: 0.5rem; }
        .py-4 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .border-top { border-top: 1px solid #dee2e6; }
        .border-bottom { border-bottom: 1px solid #dee2e6; }

        /* コンテナ */
        .container-main { max-width: 1300px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 4px; position: relative; }

        /* ボタン */
        .btn { display: inline-block; font-weight: 400; text-align: center; vertical-align: middle; cursor: pointer; border: 1px solid transparent; padding: 0.375rem 0.75rem; font-size: 1rem; border-radius: 0.25rem; transition: all 0.15s; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #5c636a; }
        .btn-success { color: #fff; background-color: #198754; border-color: #198754; }
        .btn-success:hover { background-color: #157347; }
        .btn-outline-secondary { color: #6c757d; border-color: #6c757d; background: white; }
        .btn-outline-secondary:hover { color: #fff; background-color: #6c757d; }
        
        /* フォーム */
        .form-control { display: block; width: 100%; padding: 0.375rem 0.75rem; font-size: 1rem; border: 1px solid #ced4da; border-radius: 0.25rem; }
        textarea.form-control { resize: vertical; }

        /* アラート */
        .alert { position: relative; padding: 1rem 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.25rem; }
        .alert-warning { color: #664d03; background-color: #fff3cd; border-color: #ffecb5; }
        .alert-info { color: #055160; background-color: #cff4fc; border-color: #b6effb; }

        /* グリッドシステム簡易版 */
        .row { display: flex; flex-wrap: wrap; margin-right: -0.75rem; margin-left: -0.75rem; }
        .col-auto { flex: 0 0 auto; width: auto; padding: 0 0.75rem; }
        .col-md-3 { flex: 0 0 auto; width: 25%; padding: 0 0.75rem; }
        .col-md-4 { flex: 0 0 auto; width: 33.3333%; padding: 0 0.75rem; }
        .col-md-5 { flex: 0 0 auto; width: 41.6667%; padding: 0 0.75rem; }
        .col-md-6 { flex: 0 0 auto; width: 50%; padding: 0 0.75rem; }

        /* タブ (カスタム実装) */
        .sticky-tabs { position: -webkit-sticky; position: sticky; top: 0; z-index: 900; background-color: #f4f6f9; padding-top: 10px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; }
        .nav-tabs { display: flex; list-style: none; padding-left: 0; margin-bottom: 0; border-bottom: 1px solid #dee2e6; }
        .nav-item { margin-bottom: -1px; }
        .nav-link { display: block; padding: 0.5rem 1rem; text-decoration: none; background-color: #e9ecef; border: 1px solid #dee2e6; margin-right: 4px; color: #555; font-weight: 500; border-top-left-radius: 0.25rem; border-top-right-radius: 0.25rem; cursor: pointer; }
        .nav-link:hover { background-color: #dde0e3; }
        .nav-link.active { color: #0d6efd; background-color: #fff; border-color: #dee2e6 #dee2e6 #fff; font-weight: bold; }
        .tab-content > .tab-pane { display: none; }
        .tab-content > .tab-pane.show { display: block; }

        /* テーブル設定 */
        .table { width: 100%; margin-bottom: 1rem; vertical-align: top; border-color: #dee2e6; border-collapse: collapse; }
        .table-bordered th, .table-bordered td { border: 1px solid #dee2e6; }
        .table-custom { font-size: 15px; }
        .table-custom th { background-color: #2c3e50 !important; color: #ffffff !important; text-align: center; font-weight: 600; padding: 8px; white-space: nowrap; }
        .table-custom td { padding: 6px 8px; line-height: 1.3; vertical-align: middle; }
        .table-fixed { table-layout: fixed; }
        .cell-nowrap { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-wrap { word-wrap: break-word; overflow-wrap: break-word; }

        /* ハイライト */
        tr.row-none td { background-color: #ffffff; color: #333; }
        tr.row-alert td { background-color: #ffe6e6; color: #b00; font-weight: bold; }
        tr.row-gray td { background-color: #f2f2f2; color: #666; }

        /* トップへ戻るボタン */
        #backToTop { display: none; position: fixed; bottom: 30px; right: 30px; z-index: 2000; font-size: 18px; border: none; background-color: #0d6efd; color: white; cursor: pointer; padding: 10px 15px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); opacity: 0.8; transition: opacity 0.3s; }
        #backToTop:hover { opacity: 1; background-color: #0b5ed7; }

        /* モーダル (カスタム実装) */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-dialog { margin: 1.75rem auto; max-width: 90%; width: 210mm; }
        .modal-content { position: relative; display: flex; flex-direction: column; width: 100%; pointer-events: auto; background-color: #fff; border: 1px solid rgba(0,0,0,.2); border-radius: 0.3rem; outline: 0; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1rem; border-bottom: 1px solid #dee2e6; }
        .modal-body { position: relative; flex: 1 1 auto; padding: 1rem; background-color: #6c757d; }
        .modal-footer { display: flex; flex-wrap: wrap; align-items: center; justify-content: flex-end; padding: 0.75rem; border-top: 1px solid #dee2e6; }
        .btn-close { padding: 0.5rem; margin: -0.5rem -0.5rem -0.5rem auto; background: transparent; border: 0; font-size: 1.5rem; font-weight: 700; line-height: 1; color: #000; text-shadow: 0 1px 0 #fff; opacity: .5; cursor: pointer; }

        /* 参考文献 */
        .citation-list { padding-left: 0; list-style: none; margin-bottom: 0; }
        .citation-item { padding-left: 1.5em; text-indent: -1.5em; margin-bottom: 2px; font-size: 0.85rem; }

        /* --- 抗凝固プロトコル用スタイル --- */
        #ac-wrapper h1 { text-align: center; color: #2c3e50; border-bottom: 3px solid #34495e; padding-bottom: 15px; margin-bottom: 30px; font-size: 24px; }
        #ac-wrapper .date-section { background-color: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #ac-wrapper .step-box { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; height: 100%; }
        #ac-wrapper h2 { font-size: 1.1rem; color: #2980b9; margin-top: 0; border-left: 5px solid #2980b9; padding-left: 10px; }
        #ac-wrapper button.custom-btn { padding: 12px; font-size: 0.95rem; text-align: left; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 8px; color: #333; }
        #ac-wrapper button.custom-btn:hover { background-color: #eaf2f8; border-color: #3498db; }
        #ac-wrapper button.custom-btn.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: bold; }
        #ac-wrapper .risk-col { padding: 15px; border-radius: 6px; border: 2px solid transparent; height: 100%; }
        #ac-wrapper .risk-high { background-color: #fff5f5; border-color: #e74c3c; }
        #ac-wrapper .risk-low { background-color: #f0f9ff; border-color: #3498db; }
        #ac-wrapper .risk-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; text-align: center; padding: 5px; border-radius: 4px; color: white; }
        #ac-wrapper .risk-high .risk-title { background-color: #c0392b; }
        #ac-wrapper .risk-low .risk-title { background-color: #2980b9; }
        #ac-wrapper .definition-box { font-size: 0.85rem; background: #fff; padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
        #ac-wrapper .action-box { font-size: 1.1rem; font-weight: bold; padding: 15px; background: #fff; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #ac-wrapper .schedule-info { margin-top: 15px; padding-top: 10px; border-top: 1px dotted #ccc; font-size: 1.1rem; color: #c0392b; text-align: center; }
        #ac-wrapper table.ref-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        #ac-wrapper table.ref-table th, #ac-wrapper table.ref-table td { border: 1px solid #888; padding: 5px; vertical-align: top; }
        #ac-wrapper .bg-header { background-color: #343a40; color: #fff; }
        #ac-wrapper .bg-warfarin { background-color: #fff3cd; }
        #ac-wrapper .bg-doac { background-color: #d1e7dd; }
        #ac-wrapper .bg-platelet { background-color: #fff9c4; }

        /* メニュー */
        #menu-toggle-btn { position: fixed; top: 15px; right: 20px; z-index: 9999; width: 50px; height: 50px; background-color: #333; border: 2px solid #fff; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .bar { width: 28px; height: 3px; background-color: white; border-radius: 2px; }
        #menu-content { display: none; position: fixed; top: 75px; right: 20px; width: 260px; background-color: #333; border: 1px solid #555; border-radius: 8px; padding: 15px; z-index: 9998; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        #menu-content.active { display: block; }
        .menu-link { display: block; color: white; text-decoration: none; padding: 12px 15px; margin-bottom: 6px; border-radius: 4px; background-color: #444; font-weight: bold; }
        .menu-link:hover { background-color: #0d6efd; }

        /* 印刷設定 */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-size: 11pt; }
            .no-print, .nav-tabs, .btn, .form-control, .alert, #backToTop, .sticky-tabs, #custom-hamburger-menu { display: none !important; }
            .container-main { box-shadow: none; margin: 0; padding: 0; width: 100%; max-width: 100%; }
            .print-header { display: flex !important; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            
            .tab-pane { display: none !important; }
            .tab-pane.active { display: block !important; }

            /* 色付け強制 */
            tr.row-alert td { background-color: #ffe6e6 !important; }
            tr.row-gray td { background-color: #f2f2f2 !important; }
            #ac-wrapper .risk-high { background-color: #fff5f5 !important; }
            #ac-wrapper .risk-low { background-color: #f0f9ff !important; }

            .modal { position: static; display: block; background: none; height: auto; overflow: visible; }
            .modal-dialog { max-width: 100%; width: 100%; margin: 0; }
            .modal-content { border: none; }
            .modal-header, .modal-footer { display: none; }
            .modal-body { padding: 0; background: white; }

            /* 抗凝固タブ印刷用 */
            #ac-wrapper .selection-area, #ac-wrapper .date-section { display: none; }
            #ac-wrapper details { display: block !important; }
            #ac-wrapper summary { display: none; }

            #printCitationList { column-count: 2; column-gap: 20px; font-size: 9pt; margin-top: 10px; }
            @page { margin: 10mm; size: auto; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

<div id="custom-hamburger-menu" class="no-print">
    <button id="menu-toggle-btn" onclick="toggleMenu()" title="メニュー">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    <nav id="menu-content">
        <div style="color:#aaa; font-size:12px; text-align:center; border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:10px;">業務支援ツール統合メニュー</div>
        <a href="index.html" class="menu-link">🏠 メニュー画面へ</a>
        <hr style="margin:8px 0; border-color:#555;">
        <a href="休薬確認ツール.html" class="menu-link">💊 休薬確認ツール</a>
        <a href="配合変化ツール.html" class="menu-link">💉 配合変化ツール</a>
        <a href="小児投与量確認ツール.html" class="menu-link">👶 小児用量監査</a>
        <button onclick="toggleMenu()" style="width:100%; margin-top:10px; background:transparent; border:1px solid #777; color:#ccc; padding:5px; cursor:pointer;">閉じる</button>
    </nav>
</div>

<button id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'});">▲</button>

<div class="container-main">
    <div class="d-flex justify-content-between align-items-center no-print mb-3">
        <h3 class="fw-bold m-0">🏥 術前休薬確認ツール Ver15.0</h3>
        <button class="btn btn-secondary btn-sm" onclick="window.location.reload()">リセット</button>
    </div>

    <div class="alert alert-warning small no-print">
        <strong>【ご注意】</strong> 本表は汎用薬を抜粋したものです。これ以外にも留意すべき薬剤があります。あくまでも一目安としてご利用ください。
    </div>

    <div class="sticky-tabs no-print">
        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link active" onclick="switchTab('check-tab')">① 判定・リスト作成</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('schedule-tab')">② 休薬日確認</a></li>
            <li class="nav-item"><a class="nav-link" id="master-tab-btn" onclick="switchTab('master-tab')">③ 薬剤一覧検索</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('anticoagulant-tab')">④ 抗凝固・抗血小板薬プロトコル</a></li>
        </ul>
    </div>

    <div class="tab-content">
        <div id="check-tab" class="tab-pane show active">
            <div class="row g-2 mb-3 no-print">
                <div class="col-md-5">
                    <textarea id="rawInput" class="form-control" rows="4" placeholder="電子カルテ等の薬剤リストをここに貼り付けてください"></textarea>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">手術予定日</label>
                    <input type="date" id="surgeryDate" class="form-control" onchange="processData()">
                    <div class="text-primary small mt-1">※手術日未入力でも判定可能。入力で期間を表示。</div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mb-2 fw-bold" onclick="processData()">判定実行</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary w-50" onclick="showPreview()">プレビュー</button>
                        <button class="btn btn-success w-50" onclick="window.print()">印刷</button>
                    </div>
                </div>
            </div>

            <div class="print-header">
                <div style="font-size: 16pt; font-weight: bold;">薬剤休薬確認リスト</div>
                <div id="printDateDisplay" style="font-size: 12pt; font-weight: bold;">手術予定日：未設定</div>
            </div>
            <div class="d-none d-print-block small border-bottom mb-2 pb-1">
                ※本表は汎用薬を抜粋したものです。これ以外にも留意すべき薬剤があります。あくまでも一目安としてご利用ください。
            </div>

            <table class="table table-bordered table-custom" id="resultTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">薬剤名(判定)</th>
                        <th style="width: 12%;">分類</th>
                        <th style="width: 13%;">休薬期間</th>
                        <th class="col-calc" style="width: 25%;">推奨休薬期間・開始日</th>
                        <th style="width: 25%;">休薬理由</th>
                        <th style="width: 5%;">引用</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="text-center text-muted py-4">データを入力して「判定実行」を押してください</td></tr>
                </tbody>
            </table>

            <div class="mt-2 border-top pt-2 no-print">
                <small class="text-muted fw-bold">引用元:</small>
                <div id="citationList" class="citation-list small text-muted"></div>
            </div>
            <div class="mt-2 border-top pt-2 d-none d-print-block">
                <small class="fw-bold">【引用・根拠】</small>
                <div id="printCitationList" class="citation-list"></div>
            </div>
        </div>

        <div id="schedule-tab" class="tab-pane">
            <div class="print-header">
                <div style="font-size: 16pt; font-weight: bold;">休薬日確認カレンダー</div>
                <div id="printScheduleDateDisplay" style="font-size: 12pt; font-weight: bold;">手術予定日：未設定</div>
            </div>
            <div class="row align-items-center mb-3 no-print">
                <div class="col-auto"><label class="fw-bold">手術予定日：</label></div>
                <div class="col-auto"><input type="date" id="scheduleDateInput" class="form-control" onchange="calcScheduleTab()"></div>
                <div class="col-auto"><button class="btn btn-success" onclick="window.print()">このページを印刷</button></div>
            </div>
            <div id="scheduleResultArea" class="table-custom"></div>
        </div>

        <div id="master-tab" class="tab-pane">
            <div class="mb-2">
                <input type="text" id="masterSearch" class="form-control" placeholder="薬剤名を入力（スペース区切りで複数検索可能）" onkeyup="filterMasterTable()">
            </div>
            <div style="height: 650px; overflow-y: auto;">
                <table class="table table-custom table-fixed">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th style="width: 12%;">分類</th>
                            <th style="width: 18%;">商品名</th>
                            <th style="width: 12%;">一般名</th>
                            <th style="width: 18%;">休薬期間</th>
                            <th style="width: 40%;">理由</th>
                        </tr>
                    </thead>
                    <tbody id="masterTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="anticoagulant-tab" class="tab-pane">
            <div id="ac-wrapper">
                <h1>手術時 抗凝固・抗血小板薬 休薬・置換プロトコル</h1>
                <div class="date-section no-print">
                    <label class="date-label">📅 手術予定日：</label>
                    <input type="date" id="ac-surgery-date" onchange="updateACDisplay()">
                    <span style="font-size:0.9rem; margin-left:10px; color:#666;">（入力すると休薬開始日を自動計算します）</span>
                </div>
                <div class="selection-area no-print">
                    <div class="step-box">
                        <h2>1. 薬剤を選択</h2>
                        <div class="btn-group-custom" id="drug-buttons">
                            <button class="custom-btn" onclick="setACDrug('warfarin', this)">ワーファリン</button>
                            <button class="custom-btn" onclick="setACDrug('doac_pe', this)">DOAC：プラザキサ / エリキュース</button>
                            <button class="custom-btn" onclick="setACDrug('doac_il', this)">DOAC：イグザレルト / リクシアナ</button>
                            <button class="custom-btn" onclick="setACDrug('platelet_main', this)">抗血小板薬：バイアスピリン/パナルジン/クロピドグレル/エフィエント</button>
                            <button class="custom-btn" onclick="setACDrug('platelet_cilo', this)">抗血小板薬：シロスタゾール</button>
                        </div>
                    </div>
                    <div class="step-box">
                        <h2>2. 手術・処置を選択</h2>
                        <div class="btn-group-custom" id="surgery-buttons">
                            <button class="custom-btn" onclick="setACSurgery('dental', this)">抜歯・白内障（局所麻酔）</button>
                            <button class="custom-btn" onclick="setACSurgery('minor', this)">体表の小手術（圧迫等容易）</button>
                            <button class="custom-btn" onclick="setACSurgery('major', this)">圧迫が困難な場合、大手術</button>
                            <button class="custom-btn" onclick="setACSurgery('spinal', this)">脊髄・硬膜外麻酔 / カテーテル抜去</button>
                        </div>
                    </div>
                </div>
                <div id="ac-result-area" style="display:none;">
                    <h3 style="text-align:center; margin-bottom:20px;">推奨される対応（病態リスク別）</h3>
                    <div class="comparison-container">
                        <div class="risk-col risk-high">
                            <div class="risk-title">高リスク病態</div>
                            <div class="definition-box" id="high-risk-def"></div>
                            <div class="action-box">
                                <div id="high-risk-action"></div>
                                <div id="high-schedule" class="schedule-info" style="display:none;"></div>
                            </div>
                        </div>
                        <div class="risk-col risk-low">
                            <div class="risk-title">低リスク病態</div>
                            <div class="definition-box" id="low-risk-def"></div>
                            <div class="action-box">
                                <div id="low-risk-action"></div>
                                <div id="low-schedule" class="schedule-info" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="footer-info" id="footer-note" style="display:none;">
                        <div class="footer-title">★ 再開・ヘパリン置換に関する注意</div>
                        <div id="footer-text"></div>
                    </div>
                </div>
                
                <div class="text-end no-print mb-3 mt-3">
                    <button class="btn btn-success" onclick="window.print()">このページを印刷</button>
                </div>

                <details open class="no-print">
                    <summary>（参考）休薬・置換プロトコル全図表</summary>
                    <div class="table-container">
                        <table class="ref-table">
                            <thead><tr class="bg-header"><th class="col-drug">薬剤</th><th class="col-risk">リスク分類・定義</th><th class="col-surg-sm">抜歯・白内障</th><th class="col-surg-sm">体表の小手術<br>(圧迫が容易)</th><th class="col-surg-lg">圧迫困難な場合<br>大手術</th><th class="col-surg-lg">脊髄・硬膜外麻酔<br>カテーテル抜去</th></tr></thead>
                            <tbody>
                                <tr class="bg-warfarin"><td rowspan="2" class="txt-center txt-bold no-wrap">ワーファリン</td><td><span class="txt-bold">高リスク病態</span><div class="risk-list"><div class="hanging-item">・心原性脳塞栓症の既往</div><div class="hanging-item">・弁膜症を合併する心房細動</div><div class="hanging-item">・弁膜症ではないが脳卒中の高リスク心房細動</div><div class="hanging-item">・機械弁置換術後の血栓塞栓症の既往</div><div class="hanging-item">・僧帽弁の機械弁置換術後</div><div class="hanging-item">・抗リン脂質抗体症候群</div><div class="hanging-item">・深部静脈血栓症・肺塞栓症</div></div></td><td rowspan="2" class="txt-center"><span class="txt-bold">継続下での施行推奨</span><br>(治療域内確認)<br><br>※カテーテル留置はやむを得ない場合、留置中はINR&lt;3.0</td><td rowspan="2" class="txt-center"><span class="txt-bold">休薬なし</span><br>(治療域内確認)</td><td><span class="txt-bold no-wrap">【休薬】3～5日</span><div class="heparin-note">中止翌日よりヘパリン置換</div></td><td><span class="txt-bold no-wrap">【休薬】5日</span><div class="heparin-note">中止翌日よりヘパリン置換</div><br>穿刺前: PT-INR&lt;1.2<br>抜去時: INR&lt;1.5</td></tr>
                                <tr class="bg-warfarin"><td><span class="txt-bold">低リスク病態</span><div class="risk-list"><div class="hanging-item">左記以外</div></div></td><td><span class="txt-bold no-wrap">【休薬】3～5日</span></td><td>穿刺前: PT-INR&lt;1.2を確認<br>(低リスク群では休薬なし)</td></tr>
                                <tr class="bg-doac"><td rowspan="2" class="txt-center txt-bold"><span class="no-wrap">DOAC</span><span class="drug-list no-wrap"><span class="drug-item">プラザキサ</span><span class="drug-item">イグザレルト</span><span class="drug-item">エリキュース</span><span class="drug-item">リクシアナ</span></span></td><td><span class="txt-bold">高リスク病態</span><div class="risk-list"><div class="hanging-item">ワーファリンに準ずる</div></div></td><td rowspan="2" class="txt-center"><span class="txt-bold">継続下での施行推奨</span></td><td rowspan="2"><span class="txt-bold no-wrap">【休薬】1日</span><br><span style="font-size:0.75rem">※プラザキサ: 継続下で施行するが、trough aPTT>80秒の場合は緊急性のない手術は避ける</span></td><td><span class="txt-bold no-wrap">【休薬】</span><br>●プラザキサ・エリキュース: <span class="txt-bold">2日</span><br>●イグザレルト・リクシアナ: <span class="txt-bold">1日</span><div class="heparin-note">プラザキサ・エリキュース: 最終投与12時間後よりヘパリン置換<br>イグザレルト・リクシアナ: 最終投与24時間後よりヘパリン置換</div></td><td><span class="txt-bold no-wrap">【休薬】</span><br>●プラザキサ: 4日(CrCl≧60)～5日(30&lt;CCr&lt;60)<br>●エリキュース: 3日<br>●イグザレルト・リクシアナ: 2日<div class="heparin-note">(置換開始時期は左記と同様)<br>抜去: APTT正常対照1.5倍未満</div></td></tr>
                                <tr class="bg-doac"><td><span class="txt-bold">低リスク病態</span><div class="risk-list"><div class="hanging-item">ワーファリンに準ずる</div></div></td><td class="txt-center"><span class="txt-bold">同上</span></td><td>低リスク群では出血時に圧迫による止血対応が可能であることから、仮に休薬する場合には休薬期間を半減期の2倍程度に留めることが合理的である</td></tr>
                                <tr class="bg-platelet"><td rowspan="2" class="txt-center txt-bold"><span class="no-wrap">抗血小板薬</span><span class="drug-list no-wrap"><span class="drug-item">バイアスピリン</span><span class="drug-item">パナルジン</span><span class="drug-item">クロピドグレル</span><span class="drug-item">エフィエント</span><span class="drug-item">シロスタゾール</span></span></td><td><span class="txt-bold">高リスク病態</span><div class="risk-list"><div class="hanging-item">・冠動脈ステント留置後2ヶ月以内</div><div class="hanging-item">・冠動脈薬剤溶出性ステント留置後12ヶ月以内</div><div class="hanging-item">・脳血行再建術後2ヶ月以内</div><div class="hanging-item">・主幹動脈に50%以上の狭窄を伴う脳梗塞又は一過性脳虚血発作</div><div class="hanging-item">・最近発症した虚血性脳卒中又は一過性脳虚血発作</div><div class="hanging-item">・閉塞性動脈硬化症でFontaine3度(安静時疼痛)以上</div><div class="hanging-item">・頸動脈エコー/頭頸部MRIで休薬危険所見</div></div></td><td rowspan="2" class="txt-center"><span class="txt-bold">継続下での施行を原則とする</span></td><td rowspan="2" class="txt-center"><span class="txt-bold">継続下での施行を原則とする</span></td><td><span class="txt-bold no-wrap">【休薬】</span><br>●主要薬: <span class="txt-bold">7日</span><br>●シロスタゾール: <span class="txt-bold">2日</span><div class="heparin-note">中止翌日よりヘパリン置換</div></td><td><span class="txt-bold no-wrap">【休薬】</span><br>（同左）<div class="heparin-note">(必要に応じて、)<br>中止翌日よりヘパリン置換<br>抜去: APTT正常対照1.5倍未満</div></td></tr>
                                <tr class="bg-platelet"><td><span class="txt-bold">低リスク病態</span><div class="risk-list"><div class="hanging-item">左記以外</div></div></td><td><span class="txt-bold no-wrap">【休薬】同上</span><br><div class="heparin-note">場合によって、中止翌日よりヘパリン置換</div></td><td class="txt-center">低リスク群では休薬なし</td></tr>
                            </tbody>
                        </table>
                        <div class="bottom-notes"><div class="note-block"><div class="note-title">ヘパリン置換を行った場合のヘパリン中止時期</div><div><strong>ワーファリン：</strong>ワーファリン再開1〜2日後に中止（中止時効果確認）。（再開5日目以降、至適INR回復の確認を行う）</div><div style="margin-top:5px;"><strong>DOAC：</strong><br>・持続静注時（未分画ヘパリン）：DOAC投与開始時に中止。<br>・皮下注時（クレキサン等）：<br>&nbsp;&nbsp;プラザキサは次回皮下注製剤投与2時間前に投与開始、次回皮下注製剤の投与中止。<br>&nbsp;&nbsp;イグザレルトは次回皮下注製剤投与0〜2時間前に投与開始。<br>&nbsp;&nbsp;エリキュース/リクシアナは次回皮下注製剤投与時間に投与開始。</div><div style="margin-top:5px;"><strong>抗血小板剤：</strong>再開3〜4日後に中止</div></div><div style="text-align:right; margin-top:10px; color:#666;">出典：2013.06 薬事委員会作成 / 2018.10 改訂</div></div>
                    </div>
                </details>
            </div>
        </div>
    </div>
</div>

<div id="previewModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>印刷プレビュー</h5>
                <button type="button" class="btn-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" style="background:#ccc; overflow:auto; max-height:80vh;">
                <div id="previewContent" style="background:white; margin:20px auto; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:210mm; min-height:297mm;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="printFromPreview()">このまま印刷</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. オフライン用タブ・モーダル制御
// ==========================================
function switchTab(tabId) {
    // タブのアクティブ化
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    // ボタン特定が難しいため、簡易的に全走査してID一致で判定する実装も可能だが、
    // ここではonclickで呼び出す方式なので、クリックされた要素にactiveをつける
    // ただし呼び出し元の要素(this)を渡していないため、href等で判定
    document.querySelectorAll('.nav-link').forEach(el => {
        if(el.getAttribute('onclick').includes(tabId)) el.classList.add('active');
    });

    // コンテンツの表示切替
    document.querySelectorAll('.tab-pane').forEach(el => {
        el.classList.remove('show', 'active');
        el.style.display = 'none';
    });
    const target = document.getElementById(tabId);
    if(target) {
        target.classList.add('show', 'active');
        target.style.display = 'block';
    }
    
    // 検索タブなら再描画
    if(tabId === 'master-tab') filterMasterTable();
}

function toggleMenu() {
    var menu = document.getElementById('menu-content');
    menu.classList.toggle('active');
}

function showPreview() {
    const activeTab = document.querySelector('.tab-pane.active').id;
    let content = "";
    if(activeTab === "check-tab") {
        const header = document.querySelector("#check-tab .print-header").outerHTML;
        const table = document.getElementById("resultTable").outerHTML;
        const refs = document.getElementById("printCitationList").outerHTML;
        content = `${header}${table}<div class="mt-4 pt-2 border-top"><small class="fw-bold">【引用・根拠】</small>${refs}</div>`;
    } else if(activeTab === "schedule-tab") {
        content = document.querySelector("#schedule-tab .print-header").outerHTML + document.getElementById("scheduleResultArea").innerHTML;
    } else {
        content = "<p class='p-3'>この画面は「印刷」ボタンから直接印刷してください。</p>";
    }
    
    document.getElementById("previewContent").innerHTML = content;
    document.getElementById("previewModal").style.display = "block";
}

function closeModal() {
    document.getElementById("previewModal").style.display = "none";
}

function printFromPreview() {
    closeModal();
    setTimeout(() => { window.print(); }, 300);
}

// トップへ戻るボタン
window.onscroll = function() {
    const btn = document.getElementById("backToTop");
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        btn.style.display = "block";
    } else {
        btn.style.display = "none";
    }
};

// ==========================================
// 2. データ定義 (VBAで置換)
// ==========================================
const citations = {
    "1": "糖尿病治療におけるSGLT2阻害薬の適正使用に関する Recommendation",
    "2": "手術などを行う際の抗凝固薬・抗血小板薬取り扱いの参考目安(院内ポータル)",
    "3": "添付文書",
    "4": "骨吸収抑制薬関連顎骨壊死の病態と管理 : 顎骨壊死検討委員会ポジションペーパー 2016",
    "5": "NCCNガイドライン：結腸癌ガイドライン・直腸癌ガイドライン",
    "6": "医薬品適正使用ガイド",
    "7": "医薬品インタビューフォーム",
    "8": "製薬企業ホームページ",
    "9": "当院代謝内分泌内科より",
    "10": "心不全治療におけるSGLT2阻害薬の適正使用に関するRecommendation",
    "11": "赤木晋介（編）, 周術期の安全な薬剤管理を考える会（執筆）. 術前休薬クイックリファレンス."
};

// ▼▼▼ VBA置換用マーカー ▼▼▼
const rawMasterData = `
分類	分類2	商品名	一般名	休薬期間	引用	休薬理由
降圧薬	ACE阻害薬	アデカット	デラプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	エースコール	テモカプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	オドリック	トランドラプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	カプトリル	カプトプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	コバシル	ぺリンドプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	ゼストリル	リシノプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	セタプリル	アラセプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	タナトリル	イミダプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	チバセン	ベナゼプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	レニベース	エナラプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ACE阻害薬	ロンゲス	リシノプリル	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	アジルバ	アジルサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	アバプロ	イルベサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	イルベタン	イルベサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	オルメテック	オルメサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	ディオバン	バルサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	ニューロタン	ロサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	ブロプレス	カンデサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB	ミカルディス	テルミサルタン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	アイミクス配合錠	イルベサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	アテディオ配合錠	バルサルタン/シルニジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	アムバロ配合錠	バルサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	イルミアクス配合錠	イルベサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	エックスフォージ配合錠	バルサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	カムシア配合錠	カンデサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	ザグラス配合錠	アジルサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	ジルムロ配合錠	アジルサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	テラムロ配合錠	テルミサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	ミカムロ配合錠	テルミサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	ユニシア配合錠	カンデサルタン/アムロジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬	レザルタス配合錠	オルメサルタン/アゼルニジピン	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/Ca拮抗薬/利尿薬	ミカトリオ配合錠	ﾃﾙﾐｻﾙﾀﾝ/ｱﾑﾛｼﾞﾋﾟﾝ/ﾋﾄﾞﾛｸﾛﾛﾁｱｼﾞﾄﾞ	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	イルトラ配合錠	イルベサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	エカード配合錠	カンデサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	カデチア配合錠	カンデサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	コディオ配合錠	バルサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	テルチア配合錠	テルミサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	バルヒディオ配合錠	バルサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	プレミネント配合錠	ロサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	ミコンビ配合錠	テルミサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARB/利尿薬	ロサルヒド配合錠	ロサルタン/ヒドロクロロチアジド	24時間前	3	術中血圧低下のリスク
降圧薬	ARNI	エンレスト	サクビトリルバルサルタン	24時間前	3	術中血圧低下のリスク
糖尿病薬	DPP-4阻害薬	エクア	ビルダグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	オングリザ	サキサグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	グラクティブ	シタグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	ザファテック	トレラグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	ザファテック(週1回)	トレラグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	ジャヌビア	シタグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	スイニー	アナグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	テネリア	テネリグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	トラゼンタ	リナグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	ネシーナ	アログリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	マリゼブ	オマリグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	DPP-4阻害薬	マリゼブ(週1回)	オマリグリプチン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	GLP-1受容体作動薬	オゼンピック皮下注(週1回)	セマグルチド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	GLP-1受容体作動薬	トルリシティ皮下注(週1回)	デュラグルチド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	GLP-1受容体作動薬	バイエッタ皮下注	エキセナチド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	GLP-1受容体作動薬	ビクトーザ皮下注	リラグルチド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	GLP-1受容体作動薬	リキスミア皮下注	リキシセナチド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	GLP-1受容体作動薬	リベルサス	セマグルチド	当日		インスリンによる血糖管理が望まれるため
肥満症治療薬	GLP-1受容体作動薬	ウゴービ皮下注(週1回)	セマグルチド	当日	（根拠なし）	インスリンによる血糖管理が望まれるため
糖尿病薬	Glu依存性ｲﾝｽﾘﾝ分泌促進薬	ツイミーグ	イメグリミン	当日		インスリンによる血糖管理が望まれるため
骨粗鬆症治療薬	SERM	エビスタ	ラロキシフェン	長期不動状態の３日前	3	静脈血栓塞栓症のリスク
骨粗鬆症治療薬	SERM	ビビアント	バゼドキシフェン	長期不動状態の３日前	3	静脈血栓塞栓症のリスク
糖尿病薬	SGLT2阻害薬	カナグル	カナグリフロジン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬	ジャディアンス	エンパグリフロジン	糖尿病3日前/心不全当日	１,10	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬	スーグラ	イプラグリフロジン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬	デベルザ	トホグリフロジン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬	フォシーガ	ダパグリフロジン	糖尿病3日前/心不全当日	１,10	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬	ルセフィ	ルセオグリフロジン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬/DPP-4阻害薬	カナリア配合錠	カナグリフロジン/テネリグリプチン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬/DPP-4阻害薬	スージャヌ配合錠	イプラグリフロジン/シタグリプチン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SGLT2阻害薬/DPP-4阻害薬	トラディアンス配合錠AP/BP	エンパグリフロジン/リナグリプチン	3日前	1	ケトアシドーシスのリスク
糖尿病薬	SU薬	アマリール	グリメピリド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬	オイグルコン	グリベンクラミド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬	グリミクロン	グリクラジド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬	クロルプロパミド	クロルプロパミド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬	ジメリン	アセトヘキサミド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬	ダオニール	グリベンクラミド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬	デアメリンS	グリクロピラミド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	SU薬/チアゾリジン薬	ソニアス配合錠LD/HD	グリメピリド/ピオグリタゾン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	α-グリコシダーゼ阻害薬	グルコバイ	アカルボース	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	α-グリコシダーゼ阻害薬	セイブル	ミグリトール	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	α-グリコシダーゼ阻害薬	ベイスン	ボグリボース	当日		インスリンによる血糖管理が望まれるため
乳児血管腫治療剤	β受容体遮断薬	ヘマンジオルシロップ	プロプラノロール	48時間前	3	全身麻酔時低血圧のリスク
飲酒量低減薬 	ｵﾋﾟｵｲﾄﾞ受容体拮抗薬/部分作動薬	セリンクロ	ナルメフェン	ｵﾋﾟｵｲﾄﾞ投与1週間前	3	術中オピオイドの効果減少
冠血管拡張薬	冠血管拡張薬	コメリアンコーワ	ジラゼプ	2日前	2	出血リスク
冠血管拡張薬	冠血管拡張薬	ロコルナール	トラピジル	2日前	2	出血リスク
血管拡張薬	血管拡張薬	オパルモン	リマプロストアルファデクス	1日前	2	出血リスク
血管拡張薬	血管拡張薬	プロレナール	リマプロストアルファデクス	1日前	2	出血リスク
血管拡張薬	血管拡張薬	へプロニカート	リマプロストアルファデクス	1日前	2	出血リスク
抗悪性腫瘍薬	抗VEGFR2抗体	サイラムザ	ラムシルマブ	4～6週間	6	創傷治癒遅延
抗悪性腫瘍薬	抗VEGF抗体	アバスチン	ベバシズマブ	4～6週間	5	創傷治癒遅延
微小血栓形成阻害剤	抗VWF抗体	カブリビ	カプラシズマブ	7日前	3	出血リスク
抗凝固薬	抗凝固薬	イグザレルト	リバーロキサバン	下記資料参照	2	出血リスク
抗凝固薬	抗凝固薬	エリキュース	アピキサバン	下記資料参照	2	出血リスク
抗凝固薬	抗凝固薬	プラザキサ	ダビガトラン	下記資料参照	2	出血リスク
抗凝固薬	抗凝固薬	リクシアナ	エドキサバン	下記資料参照	2	出血リスク
抗凝固薬	抗凝固薬	ワーファリン	ワルファリンカリウム	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	アンプラーグ	サルポグレラート	1日前	2	出血リスク
抗血小板薬	抗血小板薬	エパデール	イコサペント酸エチル	7日前	2	出血リスク
抗血小板薬	抗血小板薬	エフィエント	プラスグレル	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	キャブピリン配合錠	アスピリン/ボノプラザン	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	ケアロードLA	ベラプロスト	1日前	2	出血リスク
抗血小板薬	抗血小板薬	コンプラピン配合錠	アスピリン/クロピドグレル	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	タケルダ配合錠	アスピリン/ランソプラゾール	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	ドルナー	ベラプロスト	1日前	2	出血リスク
抗血小板薬	抗血小板薬	バイアスピリン	アスピリン	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	パナルジン	チクロピジン	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	バファリン配合錠	アスピリン/ダイアルミネート	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	プラビックス	クロピドグレル	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	ブリリンタ	チカグレロル	5日以上前	3	出血リスク
抗血小板薬	抗血小板薬	プレタール	シロスタゾール	下記資料参照	2	出血リスク
抗血小板薬	抗血小板薬	プロサイリン	ベラプロスト	1日前	2	出血リスク
抗血小板薬	抗血小板薬	ベラサスLA	ベラプロスト	1日前	2	出血リスク
抗血小板薬	抗血小板薬	ベルサンチン	ジピリダモール	2日前	2	出血リスク
抗血小板薬	抗血小板薬	ロレアス配合錠	アスピリン/クロピドグレル	下記資料参照	2	出血リスク
糖尿病薬	合剤	ソリクア配合注	ﾘｷｼｾﾅﾁﾄﾞ/ｲﾝｽﾘﾝｸﾞﾗﾙｷﾞﾝ	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	合剤	ゾルトファイ配合注	ﾘﾗｸﾞﾙﾁﾄﾞ/ｲﾝｽﾘﾝﾃﾞｸﾞﾙﾃﾞｸﾞ	当日		インスリンによる血糖管理が望まれるため
高脂血症治療薬	高脂血症治療薬	ロトリガ	ω⁻3脂肪酸エチル	7日前	ｴﾊﾟﾃﾞｰﾙを参考	出血リスク
糖尿病薬	持続性GLP-1受容体作動薬	マンジャロ皮下注(週1回)	チルゼパチド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	速効型インスリン分泌促進薬	グルファスト	ミチグリニド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	速効型インスリン分泌促進薬	シュアポスト	レパグリニド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	速効型インスリン分泌促進薬	スターシス	ナテグリニド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	速効型インスリン分泌促進薬	ファステック	ナテグリニド	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	チアゾリジン薬	アクトス	ピオグリタゾン	当日		インスリンによる血糖管理が望まれるため
糖尿病薬	チアゾリジン薬/DPP-4阻害薬	リオベル配合錠LD/HD	ピオグリタゾン/アログリプチン	当日		インスリンによる血糖管理が望まれるため
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	イムブルビカ	イブルチニブ	3〜7日	7	出血リスク
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	インライタ	アキシチニブ	24 時間以上	7	創傷治癒遅延
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	カボメティクス	カボザンチニブ	28日前	8	創傷治癒遅延
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	スーテント	スニチニブ	7～10 日前	7	創傷治癒遅延
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	スチバーガ	レゴラフェニブ	2週間	6	創傷治癒遅延
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	レンビマ	レンバチニブ	1週間	8	創傷治癒遅延
脳循環・代謝改善薬	脳循環・代謝改善薬	ケタス	イブジラスト	2日前	2	出血リスク
脳循環・代謝改善薬	脳循環・代謝改善薬	セロクラール	イフェンプロジル	2日前	2	出血リスク
糖尿病薬	ビグアナイド薬	グリコラン	メトホルミン	前後2日	9	乳酸アシドーシスのリスク
糖尿病薬	ビグアナイド薬	メトグルコ	メトホルミン	前後2日	9	乳酸アシドーシスのリスク
糖尿病薬	ビグアナイド薬/DPP-4阻害薬	イニシンク配合錠	メトホルミン/アログリプチン	前後2日	9	乳酸アシドーシスのリスク
糖尿病薬	ビグアナイド薬/DPP-4阻害薬	エクメット配合錠LD/HD	メトホルミン/ビルダグリプチン	前後2日	9	乳酸アシドーシスのリスク
糖尿病薬	ビグアナイド薬/DPP-4阻害薬	メトアナ配合錠LD/HD	メトホルミン/アナグリプチン	前後2日	9	乳酸アシドーシスのリスク
糖尿病薬	ビグアナイド薬/チアゾリジン薬	メタクト配合錠LD/HD	メトホルミン/ピオグリタゾン	前後2日	9	乳酸アシドーシスのリスク
骨粗鬆症治療薬	ビスホスホネート薬	アクトネル	リセドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	ゾメタ	ゾレドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	ダイドロネル	エチドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	パミドロン酸	パミドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	フォサマック	アレンドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	ベネット	リセドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	ボナロン	アレンドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	ボノテオ	ミノドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	ボンビバ	イバンドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
骨粗鬆症治療薬	ビスホスホネート薬	リクラスト	ゾレドロン酸	歯科手術２カ月前	4	顎骨壊死のリスク
糖尿病薬	速効型ｲﾝｽﾘﾝ分泌促進薬/α-GI	グルベス配合錠	ミチグリニド/ボグリボース	当日		インスリンによる血糖管理が望まれるため
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	アンジュ21錠,28錠	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾚﾎﾞﾉﾙｹﾞｽﾄﾚﾙ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	ジェミーナ配合錠	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾚﾎﾞﾉﾙｹﾞｽﾄﾚﾙ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	シンフェーズT28錠	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ ﾉﾙｴﾁｽﾃﾛﾝ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	トリキュラー錠21,28	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾚﾎﾞﾉﾙｹﾞｽﾄﾚﾙ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	ファボワール錠21,28	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾃﾞｿｹﾞｽﾄﾚﾙ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	フリウェル配合錠LD/ULD	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ ﾉﾙｴﾁｽﾃﾛﾝ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	マーベロン21,28	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾃﾞｿｹﾞｽﾄﾚﾙ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	ヤーズ配合錠	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾄﾞﾛｽﾋﾟﾚﾉﾝ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	ヤーズフレックス配合錠	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾄﾞﾛｽﾋﾟﾚﾉﾝ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	ラベルフィーユ21錠,28錠	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ﾚﾎﾞﾉﾙｹﾞｽﾄﾚﾙ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
女性ﾎﾙﾓﾝ薬(ピル)	卵胞ホルモン/黄体ホルモン	ルナベル配合錠LD/ULD	ｴﾁﾆﾙｴｽﾄﾗｼﾞｵｰﾙ/ ﾉﾙｴﾁｽﾃﾛﾝ	手術前４週､術後２週	3	静脈血栓塞栓症のリスク
鎮痛薬	NSAIDｓ	ボルタレン	ジクロフェナク	院内推奨期間なし	2 	消化管縫合不全のリスク･腎不全のリスク
鎮痛薬	NSAIDｓ	ナボール	ジクロフェナク	院内推奨期間なし	2 	消化管縫合不全のリスク･腎不全のリスク
鎮痛薬	NSAIDｓ	ジクトルテープ	ジクロフェナク	院内推奨期間なし	2 	消化管縫合不全のリスク･腎不全のリスク
鎮痛薬	NSAIDｓ	モービック	メロキシカム	院内推奨期間なし	2 	腎不全のリスク
鎮痛薬	NSAIDｓ	セレコックス	セレコキシブ	院内推奨期間なし	2 	冠動脈バイパス再建術では投与禁忌
抗パーキンソン病薬	D2受容体遮断薬	レキップ	ロピニロール	院内推奨期間なし	2 	腸切除･人工肛門造設術患者には慎重投与
抗精神病薬	非定形型	ロドピン	ゾテピン	院内推奨期間なし	2 	ロボトミー手術患者には慎重投与
抗精神病薬	SDA	リスパダール	リスペリドン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
抗精神病薬	SDA	インヴェガ	パリペリドン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
認知症治療薬	コリンエステラーゼ阻害	レミニール	ガランタミン	院内推奨期間なし	2 	消化管手術直後･膀胱手術直後は慎重投与
緑内障治療薬	炭酸脱水酵素阻害	トルソプト点眼液	ドルゾラミド	院内推奨期間なし	2 	眼内手術で角膜浮腫リスク増加
緑内障治療薬	α1受容体遮断	デタントール	ブナゾシン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
抗菌薬	アミノグリコシド系	ネオメドロール	フラジオマイシン・メチルプレドニゾロン	院内推奨期間なし	2 	耳手術後創傷治癒遅延のリスク
抗菌薬	アミノグリコシド系	眼・耳科用リンデロンＡ軟膏	フラジオマイシン・ベタメタゾンリン酸エステル	院内推奨期間なし	2 	耳手術後創傷治癒遅延のリスク
緑内障治療薬	炭酸脱水酵素阻害/β-遮断	コソプト配合点眼液	ドルゾラミド・チモロール	院内推奨期間なし	2 	眼内手術で角膜浮腫リスク増加
抗アレルギー薬	副腎皮質ホルモン	ナゾネックス点鼻液	モメタゾンフランカルボン酸エステル	院内推奨期間なし	2 	鼻手術後創傷治癒遅延のリスク
鼓膜穿孔治療剤	bFGF受容体刺激	リティンパ	トラフェルミン	院内推奨期間なし	2 	鼓室形成手術患者には慎重投与
降圧薬	β受容体遮断薬	ミケラン	カルテオロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	インデラル	プロプラノロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	アルセノール	アテノロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	テノーミン	アテノロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	アロチノロール	アロチノロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	ナディック	ナドロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	メインテート	ビソプロロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	ビソノテープ	ビソプロロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	セレクトール	セリプロロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	ケルロング	ベタキソロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	アーチスト	カルベジロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	カルバン	ベバントロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	Caチャネル阻害	ペルジピン	ニカルジピン	院内推奨期間なし	2 	開心術後、投与注意
抗不整脈薬	Kチャネル阻害	アンカロン	アミオダロン	院内推奨期間なし	2 	手術患者には慎重投与
利尿薬	チアジド系	フルイトラン	トリクロルメチアジド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
利尿薬	チアジド系	ヒドロクロロチアジド	ヒドロクロロチアジド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
利尿薬	チアジド系類似薬	バイカロン	メフルシド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
利尿薬	ループ系	ラシックス	フロセミド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
利尿薬	ループ系	ダイアート	アゾセミド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
利尿薬	ループ系	ルプラック	トラセミド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
高血圧・排尿障害治療	α1受容体遮断	ミニプレス	プラゾシン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
降圧薬	αβ受容体遮断	トランデート	ラベタロール	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
降圧薬	β受容体遮断薬	セロケン	メトプロロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	ロプレソール	メトプロロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
利尿薬	チアジド系類似薬	ナトリックス	インダパミド	院内推奨期間なし	2 	ﾛｸﾛﾆｳﾑの作用増強､昇圧ｱﾐﾝの作用減弱のおそれ
降圧薬	β受容体遮断薬	プロプラノロール	プロプラノロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	β受容体遮断薬	ローガン	アモスラロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
排尿障害改善薬	α1受容体遮断	エブランチル	ウラピジル	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
降圧薬	β受容体遮断薬	ハイパジールコーワ	ニプラジロール	継続を推奨	2 	中止により反跳性高血圧､虚血症状､不整脈のリスク
降圧薬	α1受容体遮断	カルデナリン	ドキサゾシン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
狭心症治療薬	β酸化の阻害	バスタレル	トリメタジジン	2日	11 	出血リスク
高リン血症治療薬	リン吸着	フォスブロック	セベラマー	院内推奨期間なし	2 	腹部手術後腸閉塞のリスク
高リン血症治療薬	リン吸着	レナジェル	セベラマー	院内推奨期間なし	2 	腹部手術後腸閉塞のリスク
高リン血症治療薬	リン吸着	ホスレノール	ランタン	院内推奨期間なし	2 	腹部手術後イレウスの報告
高リン血症治療薬	リン吸着	キックリン	ビキサロマー	院内推奨期間なし	2 	腹部手術後腸閉塞のリスク
肺高血圧症治療薬	IP受容体作動	ウプトラビ	セレキシパグ	1～3日	11 	出血リスク
褐色細胞腫治療薬	チロシン水酸化酵素阻害	デムサー	メチロシン	院内推奨期間なし	2 	褐色細胞腫の手術､高血圧･不整脈のリスク
肥大型心筋症治療薬	心筋ミオシン阻害	カムザイオス	マバカムテン	院内推奨期間なし	2 	心臓手術には慎重投与
鎮咳薬	ｵﾋﾟｵｲﾄﾞ受容体作動	コデイン	コデイン	院内推奨期間なし	2 	(禁忌)18歳未満の扁桃摘除術後･アデノイド切除術後､(慎重投与)消化管手術後･尿路手術後
鎮咳薬	ｵﾋﾟｵｲﾄﾞ受容体作動	ジヒドロコデイン	ジヒドロコデイン	院内推奨期間なし	2 	(禁忌)18歳未満の扁桃摘除術後･アデノイド切除術後､(慎重投与)消化管手術後･尿路手術後
止瀉薬	収斂･粘膜保護作用	次硝酸ビスマス	次硝酸ビスマス	院内推奨期間なし	2 	腸瘻･人工肛門で血中濃度増加のﾘｽｸ
緩下剤	蠕動運動促進	アジャスト	センナ	院内推奨期間なし	2 	腹部手術後腹痛ﾘｽｸあり
緩下剤	蠕動運動促進	ヨーデル	センナ	院内推奨期間なし	2 	腹部手術後腹痛ﾘｽｸあり
緩下剤	蠕動運動促進	プルゼニド	センノシド	院内推奨期間なし	2 	腹部手術後腹痛ﾘｽｸあり
緩下剤	便の軟化･腸管刺激	グリセリン浣腸	グリセリン	院内推奨期間なし	2 	下部消化管術直後は禁忌
緩下剤	蠕動運動促進	ピムロ	センナ・センナ実	院内推奨期間なし	2 	腹部手術後腹痛ﾘｽｸあり
緩下剤	蠕動運動促進	アローゼン	センナ・センナ実	院内推奨期間なし	2 	腹部手術後腹痛ﾘｽｸあり
緩下剤	蠕動運動促進	セチロ配合錠	ダイオウ・センナ配合剤	院内推奨期間なし	2 	腹部手術後腹痛ﾘｽｸあり
過敏性腸症候群治療薬	ゲル化	ポリフル	ポリカルボフィル	院内推奨期間なし	2 	胃全摘術後薬効発揮されない
過敏性腸症候群治療薬	5-HT3受容体阻害	イリボー	ラモセトロン	院内推奨期間なし	2 	腹部手術後イレウスのリスクあり
潰瘍性大腸炎治療薬	副腎皮質ホルモン	コレチメント	ブデソニド	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
クローン病治療薬	副腎皮質ホルモン	ゼンタコート	ブデソニド	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
潰瘍性大腸炎治療薬	副腎皮質ホルモン	レクタブル	ブデソニド	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	コートン	コルチゾン酢酸エステル	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	コートリル	ヒドロコルチゾン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	フロリネフ	フルドロコルチゾン酢酸エステル	院内推奨期間なし	2 	創傷治癒遅延のリスク
抗炎症薬	副腎皮質ホルモン	レナデックス	デキサメタゾン	院内推奨期間なし	2 	創傷治癒遅延のリスク
抗炎症薬	副腎皮質ホルモン	デカドロン	デキサメタゾン	院内推奨期間なし	2 	創傷治癒遅延のリスク
抗炎症薬	副腎皮質ホルモン	レダコート	トリアムシノロン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	リンデロン	ベタメタゾン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	ステロネマ注腸	ベタメタゾンリン酸エステル	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	プレドニン	プレドニゾロン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	メドロール	メチルプレドニゾロン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	プレドネマ注腸	プレドニゾロンリン酸エステル	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	エンペラシン配合錠	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	サクコルチン配合錠	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	セレスタミン配合錠	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	ヒスタブロック配合錠	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	プラデスミン配合錠	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	ベタセレミン配合錠	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
抗炎症薬	副腎皮質ホルモン	セレスタミン配合シロップ	ベタメタゾン・クロルフェニラミン	院内推奨期間なし	2 	周術期副腎不全に注意､ｽﾃﾛｲﾄﾞｶﾊﾞｰを検討
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	ジュリナ	エストラジオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	エストラジオール安息香酸エステル	エストラジオール安息香酸エステル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	ペラニンデポー筋注	エストラジオール吉草酸エステル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	プロギノン・デポー筋注	エストラジオール吉草酸エステル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	ディビゲル	エストラジオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	ル・エストロジェル	エストラジオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	エストラーナテープ	エストラジオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	エストリール	エストリオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	ホーリン	エストリオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	黄体ホルモン	エフメノ	プロゲステロン	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	プレマリン	エストロゲン	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	黄体ホルモン	ヒスロン	メドロキシプロゲステロン酢酸エステル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	ダイホルモン・デポー注	テストステロンエナント酸エステル・エストラジオール吉草酸エステル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン	プリモジアン・デポー筋注	テストステロンエナント酸エステル・エストラジオール吉草酸エステル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン/黄体ホルモン	プラノバール配合錠	ノルゲストレル・エチニルエストラジオール	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン/黄体ホルモン	ウェールナラ配合錠	エストラジオール・レボノルゲストレル	主治医判断	2 	長期臥床で血栓リスク
女性ﾎﾙﾓﾝ薬	卵胞ホルモン/黄体ホルモン	メノエイドコンビパッチ	エストラジオール・ノルエチステロン酢酸エステル	主治医判断	2 	長期臥床で血栓リスク
陣痛誘発・促進剤	PGE2製剤	プロスタグランジン	ジノプロストン	院内推奨期間なし	2 	帝王切開･子宮切開歴は投与禁忌
短腸症候群治療薬	GLP-2ｱﾅﾛｸﾞ	レベスティブ皮下注	テデュグルチド	院内推奨期間なし	2 	術後の患者→慎重に投与
肥満症治療薬	GLP-1受容体作動薬	ゼップバウンド皮下注	チルゼパチド	院内推奨期間なし	2 	インスリンによる血糖管理が望まれるため
治療的流産	プロスタグランジンE2製剤	プレグランディン腟坐剤	ゲメプロスト	院内推奨期間なし	2 	帝王切開･子宮切開歴は慎重投与
子宮頸管熟化剤	プロスタグランジンE2製剤	プロウペス腟用剤	ジノプロストン	院内推奨期間なし	2 	子宮筋層の切開を伴う手術歴は投与禁忌
女性ﾎﾙﾓﾝ薬	黄体ホルモン	ミレーナ	レボノルゲストレル	院内推奨期間なし	2 	骨盤内手術後､術部の回復を確認してから装着
前立腺肥大症治療薬	α1受容体遮断	ハルナール	タムスロシン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
前立腺肥大症治療薬	α1受容体遮断	フリバス	ナフトピジル	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
前立腺肥大症治療薬	α1A受容体遮断	ユリーフ	シロドシン	院内推奨期間なし	2 	白内障手術時､術中虹彩緊張低下症候群のリスク
緑内障・高眼圧症治療剤	プロスタマイド受容体刺激	グラッシュビスタ外用液剤	ビマトプロスト	院内推奨期間なし	2 	内眼手術の既往で黄斑浮腫のリスク
皮膚潰瘍治療剤	プロスタグランジンE1製剤	プロスタンディン軟膏	アルプロスタジル　アルファデクス	院内推奨期間なし	2 	出血リスク
壊死組織除去剤	タンパク質分解作用	ネキソブリッド外用ゲル	パイナップル茎搾汁精製物	院内推奨期間なし	2 	減張切開創に塗布で出血リスク
徐放性カリウム剤	カリウム補充	塩化カリウム	塩化カリウム	院内推奨期間なし	2 	消化管吻合術後吸収率低下のおそれ
抗プラスミン剤	抗プラスミン剤	トランサミン	トラネキサム酸	院内推奨期間なし	2 	血栓のリスク
血液凝固阻止剤	血液凝固系阻害	ヘパリンＣａ皮下注	ヘパリン	院内推奨期間なし	2 	出血リスク
血液凝固阻止剤	血液凝固系阻害	フラグミン静注	ダルテパリン	院内推奨期間なし	2 	出血リスク
抗リウマチ剤	免疫抑制剤	メタルカプターゼ	ペニシラミン	院内推奨期間なし	2 	手術直後重篤な血液障害のリスク
抗血栓性末梢循環改善剤	血漿フィブリノゲン濃度低下	デフィブラーゼ点滴	バトロキソビン	院内推奨期間なし	2 	出血リスク
抗リウマチ剤	免疫抑制剤	プログラフ	タクロリムス	院内推奨期間なし	2 	ﾘｳﾏﾁ患者で人工関節手術の臨床試験無し
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	オフェブ	ニンテダニブ	主治医判断	2 	創傷治癒遅延のリスク
抗リウマチ剤	TNFα／LTαレセプター製剤 	エンブレル	エタネルセプト	院内推奨期間なし	2 	手術前後の臨床試験無し
骨吸収抑制	抗RANKL抗体	ランマーク皮下注	デノスマブ	院内推奨期間なし	2 	顎骨壊死のリスク
骨粗鬆症治療薬	抗RANKL抗体	プラリア皮下注	デノスマブ	院内推奨期間なし	2 	顎骨壊死のリスク
骨粗鬆症治療薬	抗スクレロスチン抗体	イベニティ皮下注	ロモソズマブ	院内推奨期間なし	2 	顎骨壊死のリスク
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	ネクサバール	ソラフェニブ	主治医判断	2 	創傷治癒遅延のリスク
抗悪性腫瘍薬	血管新生抑制	サレドカプセル	サリドマイド	主治医判断	2 	創傷治癒遅延のリスク
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	ヴォトリエント	パゾパニブ	主治医判断	2 	創傷治癒遅延のリスク
抗悪性腫瘍薬	mTOR阻害	ラパリムス	シロリムス	主治医判断	2 	創傷治癒遅延のリスク
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	カプレルサ	バンデタニブ	主治医判断	2 	創傷治癒遅延のリスク
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	ベレキシブル	チラブルチニブ	主治医判断	2 	出血リスク
抗悪性腫瘍薬	ﾁﾛｼﾝｷﾅｰｾﾞ阻害薬	フリュザクラ	フルキンチニブ	主治医判断	2 	創傷治癒遅延のリスク
抗リウマチ剤	免疫抑制剤	リマチル	ブシラミン	院内推奨期間なし	2 	感染リスク
気管支喘息治療薬	TXA2合成阻害	ドメナン	オザグレル	院内推奨期間なし	2 	出血リスク
減感作療法薬	減感作療法	アシテアダニ舌下錠	ダニアレルゲンエキス	院内推奨期間なし	2 	口腔内術後吸収率変化のリスク
減感作療法薬	減感作療法	ミティキュアダニ舌下錠	ダニアレルゲンエキス	院内推奨期間なし	2 	口腔内術後吸収率変化のリスク
減感作療法薬	減感作療法	シダキュアスギ花粉舌下錠	標準化スギ花粉エキス（２）	院内推奨期間なし	2 	口腔内術後吸収率変化のリスク
抗菌薬	葉酸合成阻害	ダイフェン	スルファメトキサゾール・トリメトプリム	院内推奨期間なし	2 	胃摘出術後貧血リスク
抗菌薬	葉酸合成阻害	バクタ	スルファメトキサゾール・トリメトプリム	院内推奨期間なし	2 	胃摘出術後貧血リスク
抗菌薬	葉酸合成阻害	バクトラミン	スルファメトキサゾール・トリメトプリム	院内推奨期間なし	2 	胃摘出術後貧血リスク
造影剤	注腸用X線造影剤	コロンフォート内用懸濁液	硫酸バリウム	院内推奨期間なし	2 	消化管切除後穿孔のリスク
造影剤	大腸CT用経口造影剤	エネマスター注腸散	硫酸バリウム	院内推奨期間なし	2 	消化管切除後穿孔のリスク
下剤	下剤	マグコロール散	クエン酸マグネシウム	院内推奨期間なし	2 	腹部外科手術後腸閉塞や腸管穿孔のリスク
診断用剤 	診断用剤 	ピロニック	尿素（１３Ｃ）	院内推奨期間なし	2 	胃切除後判定に影響する可能性
診断用剤 	診断用剤 	ユービット	尿素（１３Ｃ）	院内推奨期間なし	2 	胃切除後判定に影響する可能性
診断用剤 	診断用剤 	アラグリオ	アミノレブリン酸	院内推奨期間なし	2 	手術後４８時間は強い光への眼・皮膚の曝露を回避
診断用剤 	診断用剤 	アラベル	アミノレブリン酸	院内推奨期間なし	2 	手術後４８時間は強い光への眼・皮膚の曝露を回避
経口腸管洗浄剤 	経口腸管洗浄剤 	ニフレック	ナトリウム・カリウム配合剤	院内推奨期間なし	2 	腹部手術後腸閉塞のリスク
経口腸管洗浄剤 	経口腸管洗浄剤 	ビジクリア	リン酸二水素ナトリウム一水和物・無水リン酸水素二ナトリウム	院内推奨期間なし	2 	腹部外科手術後腸閉塞や腸管穿孔のリスク
経口腸管洗浄剤 	経口腸管洗浄剤 	モビプレップ	塩化ナトリウム・塩化カリウム・無水硫酸ナトリウム・マクロゴール４０００・アスコルビン酸・Ｌ－アスコルビン酸ナトリウム	院内推奨期間なし	2 	腹部手術後腸閉塞のリスク
経口腸管洗浄剤 	経口腸管洗浄剤 	ピコプレップ	ピコスルファート・酸化マグネシウム・無水クエン酸	院内推奨期間なし	2 	腹部外科手術後腸閉塞や腸管穿孔のリスク
経口腸管洗浄剤 	経口腸管洗浄剤 	サルプレップ	無水硫酸ナトリウム・硫酸カリウム・硫酸マグネシウム水和物	院内推奨期間なし	2 	腹部手術後腸閉塞のリスク
禁煙補助薬	禁煙補助薬	ニコチネル	ニコチン	院内推奨期間なし	2 	PCI･CABG直後症状悪化リスク禁忌
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	アヘン末	アヘン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	パンオピン	アヘンアルカロイド	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	モルペス	モルヒネ	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	ＭＳコンチン	モルヒネ	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	ＭＳツワイスロン	モルヒネ	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	パシーフ	モルヒネ	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	オプソ	モルヒネ	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	アンペック坐剤	モルヒネ	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	オキノーム	オキシコドン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	オキシコンチン	オキシコドン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	ナルラピド	ヒドロモルフォン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	アヘン・トコン散	アヘン・トコン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	ドーフル散	アヘン・トコン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
鎮痛薬	ｵﾋﾟｵｲﾄﾞ受容体刺激	メサペイン	メサドン	継続を推奨	2 	尿路手術後排尿障害･消化管手術直後消化管運動抑制
`; // DATA_MARKER_END
// ▲▲▲ VBA置換用マーカーここまで ▲▲▲

let masterData = [];

function init() {
    parseMasterData(rawMasterData);
    
    // 引用リスト
    const citationListEl = document.getElementById("citationList");
    const printCitationListEl = document.getElementById("printCitationList");
    let cHtml = "";
    for (const [key, val] of Object.entries(citations)) {
        cHtml += `<li class="citation-item">[${key}] ${val}</li>`;
    }
    citationListEl.innerHTML = `<ul class="citation-list">${cHtml}</ul>`;
    printCitationListEl.innerHTML = `<ul class="citation-list">${cHtml}</ul>`;

    // 検索初期表示
    filterMasterTable();
    
    // トップへ戻るボタン制御
    const backToTopBtn = document.getElementById("backToTop");
    window.onscroll = function() {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            backToTopBtn.style.display = "block";
        } else {
            backToTopBtn.style.display = "none";
        }
    };
}

function parseMasterData(rawData) {
    masterData = [];
    const lines = rawData.trim().split("\n");
    let isHeaderFound = false;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if(!line) continue;
        
        // ヘッダー行検出
        if (line.startsWith("分類")) {
            isHeaderFound = true;
            continue; 
        }
        
        if (!isHeaderFound) continue;
        
        const cols = line.split("\t");
        if (cols.length < 3) continue;
        
        masterData.push({
            type: cols[0] || "",
            type2: cols[1] || "",
            brandName: cols[2] || "",
            genericName: cols[3] || "",
            period: cols[4] || "",
            ref: cols[5] || "",
            reason: cols[6] || ""
        });
    }
}

// ==========================================
// 2. クリーニング & 判定ロジック
// ==========================================
const ngKeywords = ["薬効名称", "院内", "分１", "分２", "分３", "分４", "分５", "１日", "1日", "回", "食後", "食前", "朝", "昼", "夕", "眠前", "Rp", "Ｒｐ", "RP", "rp"];
const externalKeywords = ["点眼", "眼軟膏", "軟膏", "クリーム", "ゲル", "ローション", "パップ", "貼付", "テープ", "坐剤", "坐薬", "点鼻", "吸入", "トローチ", "うがい", "懸濁性"];
const externalForms_ClipAfter = ["懸濁性点眼液", "配合点眼液", "点眼液", "眼軟膏", "軟膏剤", "貼付剤", "吸入液", "吸入剤", "点鼻液", "点鼻剤", "クリーム", "ローション", "うがい薬", "トローチ", "パップ", "ゲル", "軟膏", "坐剤", "坐薬"];
const oralForms_ClipBefore = ["口腔内崩壊錠", "ドライシロップ", "チュアブル錠", "配合顆粒", "軟カプセル", "硬カプセル", "塩酸塩錠", "硫酸塩錠", "リン酸塩錠", "マレイン酸塩錠", "クエン酸塩錠", "フマル酸塩錠", "ナトリウム錠", "カリウム錠", "カルシウム錠", "塩酸塩カプセル", "硫酸塩カプセル", "リン酸塩カプセル", "マレイン酸塩カプセル", "ナトリウムカプセル", "配合錠", "ＯＤ錠", "カプセル", "顆粒剤", "細粒剤", "シロップ", "顆粒", "細粒", "散剤", "錠", "散", "塩酸塩", "硫酸塩", "リン酸塩", "マレイン酸塩", "クエン酸塩", "フマル酸塩", "ナトリウム", "カリウム", "カルシウム"];

function cleanDrugName(rawText) {
    if (!rawText || rawText.trim() === "") return null;
    let fullDrugName = rawText.trim();
    
    // 文字列整形
    fullDrugName = fullDrugName.replace(/（[^）]+）/g, "").replace(/^[\s　]+/, "");
    // スペースや「の手前までを取得
    const splitMatch = fullDrugName.match(/^([^\s　「]+)/);
    if(splitMatch) { fullDrugName = splitMatch[1]; }
    
    fullDrugName = fullDrugName.replace("★", "").replace("（医療用）", "");
    fullDrugName = fullDrugName.replace(/[A-Za-z0-9]/g, s => String.fromCharCode(s.charCodeAt(0) + 0xFEE0));

    let processedName = fullDrugName;
    let isExternal = externalKeywords.some(k => fullDrugName.includes(k));
    
    if (isExternal) {
        for (const form of externalForms_ClipAfter) {
            const pos = fullDrugName.indexOf(form);
            if (pos !== -1) {
                processedName = fullDrugName.substring(0, pos + form.length);
                break;
            }
        }
    } else {
        for (const form of oralForms_ClipBefore) {
            const pos = fullDrugName.indexOf(form);
            if (pos !== -1) {
                processedName = fullDrugName.substring(0, pos);
                break;
            }
        }
    }
    return processedName.trim();
}

function processData() {
    const rawInput = document.getElementById("rawInput").value;
    const surgeryDateStr = document.getElementById("surgeryDate").value;
    const resultTableBody = document.querySelector("#resultTable tbody");
    const hasDate = !!surgeryDateStr;

    // ヘッダー・列制御
    const dateText = hasDate ? new Date(surgeryDateStr).toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}) : "未設定";
    document.getElementById("printDateDisplay").textContent = "手術予定日：" + dateText;
    const colHeader = document.querySelector(".col-calc");
    if(colHeader) colHeader.style.display = hasDate ? "" : "none";

    resultTableBody.innerHTML = "";
    
    // 行分割
    const lines = rawInput.split("\n");
    
    // === 3モード自動判定 ===
    // 1. StrictRp: Rpが含まれている場合
    // 2. Indent: Rpはないが、インデント行がある場合
    // 3. Simple: 上記以外 (薬剤名リスト貼り付けなど)
    
    let hasRp = false;
    let hasIndent = false;
    
    for (const line of lines) {
        if (/Rp|Ｒｐ|RP|rp/i.test(line)) {
            hasRp = true;
            break; 
        }
        const checkStr = line.replace(/　/g, " ");
        const blankCount = checkStr.length - checkStr.trimStart().length;
        // インデントがあり、かつ空行ではない
        if (blankCount >= 2 && line.trim() !== "") {
            hasIndent = true;
        }
    }
    
    let mode = "Simple";
    if (hasRp) {
        mode = "StrictRp";
    } else if (hasIndent) {
        mode = "Indent";
    }

    let isPrevRp = false;
    let hasData = false;

    lines.forEach(line => {
        const trimmedLine = line.trim();
        let shouldKeep = false;
        
        // 空行は無視
        if (trimmedLine !== "") {
            
            if (mode === "StrictRp") {
                const isCurrentRp = /Rp|Ｒｐ|RP|rp/i.test(line);
                // 直前がRp行で、かつ現在行がRp行でないなら採用
                if (isPrevRp && !isCurrentRp) {
                    shouldKeep = true;
                }
                isPrevRp = isCurrentRp; // 次の行のために更新
                
            } else if (mode === "Indent") {
                // インデントがあり、NGワードがない行を採用
                const checkStr = line.replace(/　/g, " ");
                const blankCount = checkStr.length - checkStr.trimStart().length;
                const isNG = ngKeywords.some(ng => line.includes(ng));
                
                if (blankCount >= 2 && !isNG) {
                    shouldKeep = true;
                }
                
            } else { // Simple Mode
                // NGワードがない行を採用
                const isNG = ngKeywords.some(ng => line.includes(ng));
                if (!isNG) {
                    shouldKeep = true;
                }
            }
            
            if (shouldKeep) {
                const cleanedName = cleanDrugName(line);
                if (cleanedName) {
                    hasData = true;
                    // マッチング (前方一致 or 一般名完全一致)
                    const match = masterData.find(d => d.brandName.startsWith(cleanedName) || d.genericName === cleanedName);
                    const tr = document.createElement("tr");

                    if (match) {
                        let rowClass = "";
                        let calcText = "-";
                        
                        if (match.period.includes("院内推奨期間なし")) {
                             rowClass = "row-gray";
                             calcText = "院内推奨期間なし";
                        } else {
                            // 日付に関わらず休薬規定があればアラート色にする判定
                            const testCalc = calculateStopDateStrict(match.period, "2025-01-01");
                            if (testCalc.alert || match.period.includes("資料")) {
                                rowClass = "row-alert";
                            } else {
                                rowClass = "row-none";
                            }
                        }

                        if (hasDate && !match.period.includes("院内推奨期間なし")) {
                            const calc = calculateStopDateStrict(match.period, surgeryDateStr);
                            calcText = calc.text;
                        } else if (!hasDate && rowClass === "row-alert") {
                            calcText = match.period;
                        }

                        tr.className = rowClass;
                        tr.innerHTML = `
                            <td class="fw-bold">${cleanedName}</td>
                            <td class="small">${match.type}</td>
                            <td class="small">${match.period}</td>
                            <td class="fw-bold" style="${hasDate?'':'display:none;'}">${calcText}</td>
                            <td class="small">${match.reason}</td>
                            <td class="small text-center">${match.ref}</td>
                        `;
                    } else {
                        tr.className = "row-none";
                        tr.innerHTML = `
                            <td>${cleanedName}</td>
                            <td class="small text-muted">-</td>
                            <td class="small text-muted">指定なし</td>
                            <td class="small text-muted" style="${hasDate?'':'display:none;'}">-</td>
                            <td class="small text-muted">指定なし</td>
                            <td class="small text-muted">-</td>
                        `;
                    }
                    resultTableBody.appendChild(tr);
                }
            }
        }
    });

    if (!hasData) resultTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">有効なデータなし</td></tr>';
}

function calculateStopDateStrict(period, sDateStr) {
    const sDate = new Date(sDateStr);
    const fmt = (d) => `${d.getMonth()+1}/${d.getDate()}`;
    const addDay = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };
    
    if (period === "1～3日") return { text: `${fmt(addDay(sDate, -3))}～${fmt(addDay(sDate, -1))}`, alert: true };
    if (period === "1日前") return { text: fmt(addDay(sDate, -1)), alert: true };
    if (period === "1週間") return { text: fmt(addDay(sDate, -7)), alert: true };
    if (period === "24 時間以上") return { text: `${fmt(sDate)} 手術予定時刻の24時間以上前から休薬`, alert: true };
    if (period === "24時間前") return { text: `${fmt(sDate)} 手術予定時刻の24時間前から休薬`, alert: true };
    if (period === "28日前") return { text: fmt(addDay(sDate, -28)), alert: true };
    if (period === "2週間") return { text: fmt(addDay(sDate, -14)), alert: true };
    if (period === "2日") return { text: fmt(addDay(sDate, -2)), alert: true };
    if (period === "2日前") return { text: fmt(addDay(sDate, -2)), alert: true };
    if (period === "3〜7日") return { text: `${fmt(addDay(sDate, -7))}～${fmt(addDay(sDate, -3))}`, alert: true };
    if (period === "3日前") return { text: fmt(addDay(sDate, -3)), alert: true };
    if (period === "4～6週間") return { text: `${fmt(addDay(sDate, -42))}～${fmt(addDay(sDate, -28))}`, alert: true };
    if (period === "48時間前") return { text: `${fmt(sDate)} 手術予定時刻の48時間前から休薬`, alert: true };
    if (period === "5日以上前") return { text: `${fmt(addDay(sDate, -5))}より前から休薬`, alert: true };
    if (period === "7～10 日前") return { text: `${fmt(addDay(sDate, -10))}～${fmt(addDay(sDate, -7))}`, alert: true };
    if (period === "7日前") return { text: fmt(addDay(sDate, -7)), alert: true };
    if (period === "資料参照") return { text: "要確認", alert: true };
    if (period === "前後2日") return { text: `${fmt(addDay(sDate, -2))}～${fmt(addDay(sDate, 2))}`, alert: true };
    if (period === "当日") return { text: fmt(sDate), alert: true };
    if (period === "糖尿病3日前/心不全当日") return { text: `${fmt(addDay(sDate, -3))} または ${fmt(sDate)}`, alert: true };
    if (period === "手術前４週､術後２週") return { text: `${fmt(addDay(sDate, -28))}～${fmt(addDay(sDate, 14))}`, alert: true };
    
    if (["ｵﾋﾟｵｲﾄﾞ投与1週間前", "継続を推奨", "歯科手術２カ月前", "主治医判断", "院内推奨期間なし"].includes(period)) {
        return { text: "-", alert: false };
    }
    return { text: "-", alert: false };
}

// ==========================================
// 4. カレンダー & 検索
// ==========================================
function calcScheduleTab() {
    const dStr = document.getElementById("scheduleDateInput").value;
    const area = document.getElementById("scheduleResultArea");
    const dateText = dStr ? new Date(dStr).toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}) : "未設定";
    document.getElementById("printScheduleDateDisplay").textContent = "手術予定日：" + dateText;

    if (!dStr) { area.innerHTML = ""; return; }
    
    const schedulePatterns = ["1～3日", "1日前", "1週間", "24 時間以上", "24時間前", "28日前", "2週間", "2日", "2日前", "3〜7日", "3日前", "4～6週間", "48時間前", "5日以上前", "7～10 日前", "7日前", "ｵﾋﾟｵｲﾄﾞ投与1週間前", "資料参照", "継続を推奨", "歯科手術２カ月前", "主治医判断", "前後2日", "長期不動状態の３日前", "当日", "糖尿病3日前/心不全当日", "院内推奨期間なし", "手術前４週､術後２週"];
    let html = `<table class="table table-bordered mt-3 w-auto table-custom"><thead><tr style="background-color:#2c3e50; color:white;"><th>休薬規定</th><th>計算結果</th></tr></thead><tbody>`;
    schedulePatterns.forEach(pat => {
        const res = calculateStopDateStrict(pat, dStr);
        html += `<tr><td>${pat}</td><td>${res.text}</td></tr>`;
    });
    html += `</tbody></table>`;
    area.innerHTML = html;
}

function filterMasterTable() {
    const txt = document.getElementById("masterSearch").value;
    const tbody = document.getElementById("masterTableBody");
    tbody.innerHTML = "";
    const keywords = txt.replace(/　/g, " ").trim().split(" ").filter(k => k !== "");
    
    masterData.forEach(row => {
        let isMatch = true;
        if (keywords.length > 0) {
            const rowStr = (row.brandName + " " + row.genericName + " " + row.type).toLowerCase();
            isMatch = keywords.some(kw => rowStr.includes(kw.toLowerCase()));
        }
        if (isMatch) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="cell-nowrap">${row.type}</td><td class="fw-bold text-primary cell-nowrap">${row.brandName}</td><td class="cell-wrap">${row.genericName}</td><td>${row.period}</td><td class="small">${row.reason}</td>`;
            tbody.appendChild(tr);
        }
    });
}

// ==========================================
// 5. 抗凝固・抗血小板薬プロトコル (復元版)
// ==========================================
let currentDrug = null;
let currentSurgery = null;

const definitions = {
    warfarin: {
        high: "<div class='risk-list'><div class='hanging-item'>・心原性脳塞栓症の既往</div><div class='hanging-item'>・弁膜症を合併する心房細動</div><div class='hanging-item'>・弁膜症ではないが脳卒中の高リスク心房細動</div><div class='hanging-item'>・機械弁置換術後の血栓塞栓症の既往</div><div class='hanging-item'>・僧帽弁の機械弁置換術後</div><div class='hanging-item'>・抗リン脂質抗体症候群</div><div class='hanging-item'>・深部静脈血栓症・肺塞栓症</div></div>",
        low: "左記以外"
    },
    doac: { high: "ワーファリンに準ずる", low: "ワーファリンに準ずる" },
    platelet: {
        high: "<div class='risk-list'><div class='hanging-item'>・冠動脈ステント留置後2ヶ月以内</div><div class='hanging-item'>・冠動脈薬剤溶出性ステント留置後12ヶ月以内</div><div class='hanging-item'>・脳血行再建術後2ヶ月以内</div><div class='hanging-item'>・主幹動脈に50%以上の狭窄を伴う脳梗塞又は一過性脳虚血発作</div><div class='hanging-item'>・最近発症した虚血性脳卒中又は一過性脳虚血発作</div><div class='hanging-item'>・閉塞性動脈硬化症でFontaine3度(安静時疼痛)以上</div><div class='hanging-item'>・頸動脈エコー又は頭頸部MRIで、休薬は危険が高いとされる所見を有する</div></div>",
        low: "左記以外"
    }
};

const footerTexts = {
    warfarin: "<strong>ヘパリン置換を行った場合のヘパリン中止時期：</strong><br>ワーファリン再開1〜2日後に中止（中止時効果確認）。<br>（ワーファリン再開5日目以降、至適INR回復の確認を行う）",
    doac: "<strong>ヘパリン置換を行った場合のヘパリン中止時期：</strong><br>持続静注時（未分画ヘパリン）：DOAC投与開始時に中止。<br>皮下注時（クレキサン等）：<br>・プラザキサは次回皮下注製剤投与2時間前に投与開始、次回皮下注製剤の投与中止。<br>・イグザレルトは次回皮下注製剤投与0〜2時間前に投与開始。<br>・エリキュース/リクシアナは次回皮下注製剤投与時間に投与開始。",
    platelet: "<strong>ヘパリン置換を行った場合のヘパリン中止時期：</strong><br>抗血小板剤再開3〜4日後に中止"
};

function setACDrug(drug, btn) {
    currentDrug = drug;
    document.querySelectorAll('#drug-buttons button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    updateACDisplay();
}

function setACSurgery(surgery, btn) {
    currentSurgery = surgery;
    document.querySelectorAll('#surgery-buttons button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    updateACDisplay();
}

function getAcScheduleHtml(daysOff, sDateVal) {
    if(!sDateVal || daysOff === 0) return "";
    const sDate = new Date(sDateVal);
    const fmt = d => (d.getMonth() + 1) + '/' + d.getDate();
    
    let minDays, maxDays;
    if (Array.isArray(daysOff)) { minDays = daysOff[0]; maxDays = daysOff[1]; } 
    else { minDays = daysOff; maxDays = daysOff; }

    if (minDays === maxDays) {
        const d = new Date(sDate); d.setDate(sDate.getDate() - minDays);
        return `${fmt(d)}から休薬`;
    } else {
        const d1 = new Date(sDate); d1.setDate(sDate.getDate() - maxDays);
        const d2 = new Date(sDate); d2.setDate(sDate.getDate() - minDays);
        return `${fmt(d1)}～${fmt(d2)}から休薬`;
    }
}

function updateACDisplay() {
    if(!currentDrug || !currentSurgery) return;

    const resArea = document.getElementById('ac-result-area');
    resArea.style.display = 'block';
    
    let defKey = currentDrug.startsWith('doac') ? 'doac' : (currentDrug.startsWith('platelet') ? 'platelet' : 'warfarin');
    document.getElementById('high-risk-def').innerHTML = definitions[defKey].high;
    document.getElementById('low-risk-def').innerHTML = definitions[defKey].low;
    document.getElementById('footer-text').innerHTML = footerTexts[defKey];
    document.getElementById('footer-note').style.display = 'block';

    let h_msg = "", l_msg = "";
    let h_days = 0, l_days = 0;

    // Logic ported from previous file
    if(currentDrug === 'warfarin') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "継続下での施行推奨<br><span style='font-size:0.9rem'>（治療域内確認）</span>"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "休薬なし<br><span style='font-size:0.9rem'>（治療域内確認）</span>"; }
        else if(currentSurgery === 'major') { h_msg = "【休薬期間】3〜5日<br><div class='bridge-info'>中止翌日よりヘパリン置換</div>"; l_msg = "【休薬期間】3〜5日"; h_days = [3,5]; l_days = [3,5]; }
        else if(currentSurgery === 'spinal') { h_msg = "【休薬期間】5日<br><div class='bridge-info'>中止翌日よりヘパリン置換</div><div style='font-size:0.8rem;margin-top:5px'>※穿刺手技前にPT-INR<1.2を確認</div>"; l_msg = "穿刺手技前に、PT-INR<1.2を確認する<br><span style='font-size:0.8rem'>（低リスク群では休薬なし）</span>"; h_days = 5; }
    } else if(currentDrug === 'doac_pe') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "継続下での施行推奨"; }
        else if(currentSurgery === 'minor') { h_msg = "【休薬期間】1日<br><div class='bridge-info'>プラザキサ：継続下で施行するが、trough aPTT>80秒の場合は、緊急性のない手術は避ける</div>"; l_msg = "【休薬期間】1日<br><span style='font-size:0.8rem'>ワーファリンに準ずる</span>"; h_days = l_days = 1; }
        else if(currentSurgery === 'major') { h_msg = "【休薬期間】2日<br><div class='bridge-info'>プラザキサ・エリキュース：最終投与12時間後よりヘパリン置換</div>"; l_msg = "【休薬期間】2日"; h_days = l_days = 2; }
        else if(currentSurgery === 'spinal') { h_msg = "【休薬期間】<br>プラザキサ 4日(CrCl≧60)〜5日(30<CrCl<60)<br>エリキュース 3日<br><div class='bridge-info'>プラザキサ・エリキュース：最終投与12時間後よりヘパリン置換</div>"; l_msg = "低リスク群では出血時に圧迫による止血対応が可能であることから、仮に休薬する場合には休薬期間を半減期の2倍程度に留めることが合理的である"; h_days = [3,5]; }
    } else if(currentDrug === 'doac_il') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "継続下での施行推奨"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "【休薬期間】1日"; h_days = l_days = 1; }
        else if(currentSurgery === 'major') { h_msg = "【休薬期間】1日<br><div class='bridge-info'>イグザレルト・リクシアナ：最終投与24時間後よりヘパリン置換</div>"; l_msg = "【休薬期間】1日"; h_days = l_days = 1; }
        else if(currentSurgery === 'spinal') { h_msg = "【休薬期間】2日<br><div class='bridge-info'>イグザレルト・リクシアナ：最終投与24時間後よりヘパリン置換</div>"; l_msg = "低リスク群では出血時に圧迫による止血対応が可能であることから、仮に休薬する場合には休薬期間を半減期の2倍程度に留めることが合理的である"; h_days = 2; }
    } else if(currentDrug === 'platelet_main') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "継続下での施行を原則とする"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "継続下での施行を原則とする"; }
        else if(currentSurgery === 'major') { h_msg = "【休薬期間】7日<br><span style='font-size:0.9rem'>(バイアスピリン・パナルジン・クロピドグレル・エフィエント)</span><br><div class='bridge-info'>中止翌日よりヘパリン置換</div>"; l_msg = "【休薬期間】7日<br><div class='bridge-info'>場合によって、中止翌日よりヘパリン置換</div>"; h_days = l_days = 7; }
        else if(currentSurgery === 'spinal') { h_msg = "【休薬期間】7日<br><div class='bridge-info'>（必要に応じて、）中止翌日よりヘパリン置換</div>"; l_msg = "低リスク群では休薬なし"; h_days = 7; }
    } else if(currentDrug === 'platelet_cilo') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "継続下での施行を原則とする"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "継続下での施行を原則とする"; }
        else if(currentSurgery === 'major') { h_msg = "【休薬期間】シロスタゾール 2日<br><div class='bridge-info'>中止翌日よりヘパリン置換</div>"; l_msg = "【休薬期間】2日<br><div class='bridge-info'>場合によって、中止翌日よりヘパリン置換</div>"; h_days = l_days = 2; }
        else if(currentSurgery === 'spinal') { h_msg = "【休薬期間】シロスタゾール 2日<br><div class='bridge-info'>（必要に応じて、）中止翌日よりヘパリン置換</div>"; l_msg = "低リスク群では休薬なし"; h_days = 2; }
    }

    document.getElementById('high-risk-action').innerHTML = h_msg;
    document.getElementById('low-risk-action').innerHTML = l_msg;

    const sDateVal = document.getElementById('ac-surgery-date').value;
    const highSch = document.getElementById('high-schedule');
    const lowSch = document.getElementById('low-schedule');
    if(sDateVal) {
        highSch.style.display = 'block'; lowSch.style.display = 'block';
        highSch.innerHTML = getAcScheduleHtml(h_days, sDateVal);
        lowSch.innerHTML = getAcScheduleHtml(l_days, sDateVal);
    } else {
        highSch.style.display = 'none'; lowSch.style.display = 'none';
    }

    resArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

window.onload = init;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
